var data = {
    "lemmata" : [
        {
            "color": "indigo",
            "langs": [
                {"l":"pio", "w":"*pH₂tér", "en":"", "de":"", "fr":""},
                {"l":"pge", "w":"*fader-", "en":"", "de":"Die germanischen Sprachen unterlagen einer Lautverschiebung von p nach f.", "fr":""},
                {"l":"en", "w":"father", "en":"", "de":"", "fr":""},
                {"l":"de", "w":"Vater", "en":"", "de":"", "fr":""},
                {"l":"fr", "w":"père", "en":"", "de":"", "fr":""},
                {"l":"es", "w":"padre", "en":"", "de":"", "fr":""},
                {"l":"la", "w":"pater", "en":"", "de":"", "fr":""},
                {"l":"psl", "w":"*batę", "en":"", "de":"", "fr":""},                
                {"l":"ru", "w":"батя", "en":"batja", "de":"batja", "fr":"batja"},
                {"l":"uk", "w":"батько", "en":"batko", "de":"batko", "fr":"batko"},
                {"l":"el", "w":"πατέρας", "en":"patéras", "de":"patéras", "fr":"patéras"},
                {"l":"ga", "w":"athair", "en":"", "de":"", "fr":""},
                {"l":"fa", "w":"پدر", "en":"pedr", "de":"pedr", "fr":"pedr"}
            ]
        },
        {
            "color": "orange",
            "langs": [
                {"l":"pio", "w":"*k̂won-", "en":"", "de":"", "fr":""},
                {"l":"pge", "w":"*hunda-", "en":"", "de":"", "fr":""},
                {"l":"en", "w":"hound", "en":"", "de":"", "fr":""},
                {"l":"de", "w":"Hund", "en":"", "de":"", "fr":""},
                {"l":"fr", "w":"chien", "en":"", "de":"", "fr":""},
                {"l":"la", "w":"canis", "en":"", "de":"", "fr":""},
                {"l":"el", "w":"κύων", "en":"kúōn", "de":"kúōn", "fr":"kúōn"},
                {"l":"cy", "w":"ci", "en":"", "de":"", "fr":""},
                {"l":"ga", "w":"cù", "en":"", "de":"", "fr":""}
            ]
        },
        {
            "color": "firebrick",
            "langs": [
                {"l":"pio", "w":"*k̂erd-", "en":"", "de":"", "fr":""},
                {"l":"pge", "w":"*herton-", "en":"", "de":"", "fr":""},
                {"l":"en", "w":"heart", "en":"", "de":"", "fr":""},
                {"l":"de", "w":"Herz", "en":"", "de":"", "fr":""},
                {"l":"fr", "w":"cœur", "en":"", "de":"", "fr":""},
                {"l":"es", "w":"corazón", "en":"", "de":"", "fr":""},
                {"l":"la", "w":"cor", "en":"", "de":"", "fr":""},
                {"l":"ru", "w":"сердце", "en":"serdce", "de":"serdce", "fr":"serdce"},
                {"l":"pl", "w":"serce", "en":"", "de":"", "fr":""},
                {"l":"el", "w":"καρδιά", "en":"kardiá", "de":"kardiá", "fr":"kardiá"}
            ]
        },
        {
            "color": "lightsteelblue",
            "langs": [
                {"l":"pio", "w":"*dwóH₁", "en":"", "de":"", "fr":""},
                {"l":"pge", "w":"*twa- ", "en":"", "de":"", "fr":""},
                {"l":"en", "w":"two", "en":"", "de":"", "fr":""},
                {"l":"de", "w":"zwei", "en":"", "de":"", "fr":""},
                {"l":"fr", "w":"deux", "en":"", "de":"", "fr":""},
                {"l":"es", "w":"dos", "en":"", "de":"", "fr":""},
                {"l":"la", "w":"duo", "en":"", "de":"", "fr":""},
                {"l":"el", "w":"δύο", "en":"duo", "de":"duo", "fr":"duo"},
                {"l":"ru", "w":"два", "en":"dva", "de":"dva", "fr":"dva"},
                {"l":"pl", "w":"dwa", "en":"", "de":"", "fr":""},                             
                {"l":"ga", "w":"dà", "en":"", "de":"", "fr":""},
                {"l":"cy", "w":"dó", "en":"", "de":"", "fr":""},
                {"l":"fa", "w":"دو", "en":"dw", "de":"dw", "fr":"dw"}
            ]
        },
        {
            "color": "mediumorchid",
            "langs": [
                {"l":"pio", "w":"*h₂ébōl", "en":"", "de":"", "fr":""},
                {"l":"pge", "w":"*apluz", "en":"", "de":"", "fr":""},
                {"l":"en", "w":"apple", "en":"", "de":"", "fr":""},
                {"l":"de", "w":"Apfel", "en":"", "de":"", "fr":""},
                {"l":"ru", "w":"яблоко", "en":"dva", "de":"dva", "fr":"dva"},
                {"l":"pl", "w":"jabłko", "en":"", "de":"", "fr":""},               
                {"l":"psl", "w":"ѧблоко", "en":"", "de":"", "fr":""},        
                {"l":"ga", "w":"ubhal", "en":"", "de":"", "fr":""},
                {"l":"cy", "w":"ubhal", "en":"", "de":"", "fr":""},
                {"l":"pce", "w":"*abalo-", "en":"", "de":"", "fr":""}
            ]
        },
        {
            "color": "seagreen",
            "langs": [
                {"l":"pio", "w":"*ǵnéwo-", "en":"", "de":"", "fr":""},
                {"l":"pge", "w":"*knewą", "en":"", "de":"", "fr":""},
                {"l":"en", "w":"knee", "en":"", "de":"", "fr":""},
                {"l":"de", "w":"Knie", "en":"", "de":"", "fr":""},  
                {"l":"fr", "w":"genou", "en":"", "de":"", "fr":""},
                {"l":"la", "w":"genu", "en":"", "de":"", "fr":""},
                {"l":"el", "w":"γόνατο", "en":"gónato", "de":"gónato", "fr":"gónato"},
                {"l":"ga", "w":"glùn", "en":"", "de":"", "fr":""},
                {"l":"cy", "w":"glúin", "en":"", "de":"", "fr":""},
                {"l":"pce", "w":"*gnūnos", "en":"", "de":"", "fr":""},
                {"l":"fa", "w":"زانو", "en":"zanu", "de":"zanu", "fr":"zanu"}
            ]
        }
    ],
    "tree" : {
        "langs" : [
            {
                "l": "pio",
                "langs": [
                    { 
                        "l": "pce",
                        "langs": [
                            {"l": "ga"}, {"l": "cy"}
                        ]                    
                    },
                    {
                        "l": "la",
                        "langs": [
                            {"l": "fr"}, {"l": "es"}
                        ]                    
                    },
                    {
                        "l": "pge",
                        "langs": [
                            {"l": "en"}, {"l": "de"}
                        ]
                    },            
                    {
                        "l": "psl" ,
                        "langs": [
                            {"l": "uk"},  {"l": "ru"}
                        ]
                    },
                    {"l": "el"},            
                    {"l": "fa"}
                ]
            }
        ]
    },
    "langs" : {
        "pio" : {"en":"Indoeuropean", "de":"Indoeuropäisch", "fr":"Indoeuropéen"},
        "pge" : {"en":"Proto-Germanic", "de":"Urgermanisch", "fr":"Proto-germanique"},
        "en" : {"en":"English", "de":"Englisch", "fr":"Anglais"},
        "de" : {"en":"German", "de":"Deutsch", "fr":"Allemand"},
        "fr" : {"en":"French", "de":"Französisch", "fr":"Français"},
        "es" : {"en":"Spanish", "de":"Spanisch", "fr":"Espagnol"},
        "la" : {"en":"Latin", "de":"Latein", "fr":"Latin"},
        "el" : {"en":"Greek", "de":"Griechisch", "fr":"Grec"},
        "fa" : {"en":"Persian/Farsi", "de":"Persisch/Farsi", "fr":"Perse/Farsi"},
        "ga" : {"en":"Gaelic/Irish", "de":"Gälisch/Irisch", "fr":"Gaélique"},
        "cy" : {"en":"Welsh", "de":"Walisisch", "fr":"Gallois"},
        "pce" : {"en":"Proto-Celtic", "de":"Protokeltisch", "fr":"Proto-celtique"},
        "ru" : {"en":"Russian", "de":"Russisch", "fr":"Russe"},
        "uk" : {"en":"Ukrainian", "de":"Ukrainisch", "fr":"Ukrainien"},
        "uk" : {"en":"Polnish", "de":"Polnisch", "fr":"Polonais"},
        "psl" : {"en":"Proto-Slavic", "de":"Protoslawisch", "fr":"Proto-slave"}
    }
}

GLYPH_SIZE = 8;
TRUNK_LEMMATA = 3;
THREAD_DIST = 50;
TRUNK_HEIGHT = 200;
CROWN_SIZE = 200;
TREE_SPREAD_DEG = 200;

LANG = 'en';
var svg;
var defs;

function getRandInt(min, max)
{
    return Math.floor(Math.random() * (max - min)) + min;
}

function shuffleArray(arr) {
    for (var i=arr.length-1;i>0;i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var tmp = arr[i];
        arr[i] = arr[j];
        arr[j] = tmp;
    }
}

function getAllLemmataForLang(lang)
{
    lemmata = []
    for (var i=0;i<data.lemmata.length;i++) 
    {
        lemma = data.lemmata[i]
        for (var j=0;j<lemma.langs.length;j++)
        {
            if (lemma.langs[j].l == lang)
            {
                lemma.langs[j].color = lemma.color;
                lemmata.push(lemma.langs[j]);
            }
        }            
    }
    return lemmata;
}

function getRandomLemmataForLang(lang)
{
    lemmata = getAllLemmataForLang(lang);
    shuffleArray(lemmata);
    return lemmata;
}

function fillTreeWithLemmata(branch)
{
    branch.lemmata = getRandomLemmataForLang(branch.l);
    
    if (!branch.langs) return;
    for (var i=0;i<branch.langs.length;i++)
    {        
        fillTreeWithLemmata(branch.langs[i]);
    }    
}

function getLeaves(branch) {
    var leaves = [];
    if (!branch.langs) return [branch];
    for (var i=0;i<branch.langs.length;i++)
    {
        tip = getLeaves(branch.langs[i]);
        leaves = leaves.concat(tip);
    }
    return leaves;
}

function drawDot(x, y)
{
    var dot = svgElement('circle');
    dot.setAttribute('r', '5');
    dot.setAttribute('cx', x);
    dot.setAttribute('cy', y);
    svg.appendChild(dot);
}

function calcLeavesPos(branch) {
    var leaves = getLeaves(branch);
    var degDistance = TREE_SPREAD_DEG / (leaves.length - 1);
    for (var i=0;i<leaves.length;i++) {
        var degPos = (-TREE_SPREAD_DEG / 2 + degDistance * i) / 180 * Math.PI;
        var x = Math.sin(degPos)*CROWN_SIZE+CROWN_SIZE;
        var y = CROWN_SIZE-Math.cos(degPos)*CROWN_SIZE;
        leaves[i].pos = [x, y];   
        //drawDot(x,y);     
    }
}

function euklidianDist(pos1, pos2)
{
    return Math.sqrt(
        Math.pow(pos1[0]-pos2[0], 2) + 
        Math.pow(pos1[1]-pos2[1], 2)
    );
}

function calcBranchPos(branch)
{
    var x = 0;
    var y = 0;
    var i = 0;
    if (!branch.langs) return [branch.pos];
    while (i<branch.langs.length)
    {
        calcBranchPos(branch.langs[i]);
        x += branch.langs[i].pos[0];
        y += branch.langs[i].pos[1];
        i++;
    }
    i++;
    if (!branch.pos)
    {
        x += data.tree.pos[0];
        y += data.tree.pos[1];
        branch.pos = [x/i, y/i];
    }    

    for(i=0;i<branch.langs.length;i++)
    {
        branch.langs[i].dist = euklidianDist(branch.langs[i].pos, branch.pos);
    }

    //drawDot(branch.pos[0], branch.pos[1]);
}

function calcTreePos()
{
    calcLeavesPos(data.tree);
    data.tree.pos = [CROWN_SIZE, CROWN_SIZE+TRUNK_HEIGHT]
    calcBranchPos(data.tree);
}

function getContinuousThreadsInterval(branch, threadCountPerBranch)
{
    var distBetweenThreads = branch.langs.length*threadCountPerBranch/(threadCountPerBranch+1);
    return Math.max(Math.floor(distBetweenThreads), 1);
}

function fillUpThreads(branch, continuousThreads, threadCountPerBranch, threadDeg, degDistance)
{
    var lemmata;
    var lemmataCount = 0;
    for(var i=continuousThreads.length;i<threadCountPerBranch;i++)
    {
        lemmata = fillDistWithLemmata(branch, lemmataCount);
        lemmataCount += lemmata.length;
        continuousThreads.push([{"branch" : branch, "deg" : threadDeg, "lemmata": lemmata}]);
        threadDeg += degDistance;
    }
    return continuousThreads;   
}

function isThreadToBeContinued(i, j, continuousThreads, threadCountPerBranch, continuousThreadsInterval)
{
    return (i*threadCountPerBranch+j) % continuousThreadsInterval == 0 && continuousThreads.length < threadCountPerBranch+1;
}

function fillDistWithLemmata(branch, start)
{
    var dist = branch.dist;
    var lemmata = [];
    var coveredLength = 0;
    console.log(branch);
    for(var i=start;i<branch.lemmata.length;i++)
    {
        var lemma = branch.lemmata[i];
        coveredLength += (lemma.w.length+1)*GLYPH_SIZE;
        console.log(coveredLength, dist);
        if (coveredLength > branch.dist && i != 0)
        {
            break;
        }
        lemmata.push(lemma);
    }
    return lemmata;
}

function drawBranches(branch, threadCountPerBranch)
{
    var degDistance = TREE_SPREAD_DEG/10;
   
    var continuousThreads = [];
    if (!branch.langs) 
    {
        return fillUpThreads(branch, continuousThreads, threadCountPerBranch, 0, degDistance);         
    }
    
    var continuousThreadsInterval = getContinuousThreadsInterval(branch, threadCountPerBranch);
    var threadDeg = -degDistance * (threadCountPerBranch*branch.langs.length-1) / 2;
    var lemmata;
    var lemmataCount = 0;

    for (var i=0;i<branch.langs.length;i++)
    {
        var threads = drawBranches(branch.langs[i], Math.max(threadCountPerBranch-1, 1), threadDeg);
        
        for(var j=0;j<threads.length;j++)
        {            
            if (branch != data.tree && isThreadToBeContinued(i, j, continuousThreads, threadCountPerBranch, continuousThreadsInterval))
            {
                lemmata = fillDistWithLemmata(branch, lemmataCount);
                lemmataCount += lemmata.length;
                threads[j].push({"branch" : branch, "deg" : threadDeg, "lemmata": lemmata});
                continuousThreads.push(threads[j]);
            }
            else
            {
                threads[j].push({"branch" : branch, "deg" : threadDeg, "lemmata": []});
                drawThread(threads[j]);
            }
            threadDeg += degDistance;
        }
    }
    return continuousThreads;
}

function toSvgDString(data, cmds)
{
    str = '';
    for(var i=0;i<data.length;i++)
    {
        str += cmds[i] + ' ' + Math.round(data[i][0]) + ' ' + Math.round(data[i][1]) + ' ';
    }
    return str;
}

function orderBranch(thread)
{
    if (thread[0].branch.pos[0] > thread[thread.length-1].branch.pos[0])
    {
        thread.reverse();
        return true;
    }
    return false;
}

function applyOffset(threadElement)
{
    var deg = threadElement.deg/180*Math.PI;
    var x = Math.sin(deg)*THREAD_DIST;
    var y = -Math.cos(deg)*THREAD_DIST;
    
    var newX = threadElement.branch.pos[0]+x;
    var newY = threadElement.branch.pos[1]+y;

    return [newX, newY];
}

function calcPathCoord(thread, i)
{
    var dStr = '';
    if (i > 0)
    {   
        var next = applyOffset(thread[i]);
        var x = applyOffset(thread[i-1])[0];
        x = next[0]+(x-next[0])/2;
        dStr = toSvgDString([[x,next[1]],next], ['Q', ',']);
    }
    else
    {
        dStr = toSvgDString([applyOffset(thread[0])], ['M']);
    }
    return dStr;
}

function makePath(threadId)
{
    var path = svgElement('path');
    path.setAttribute('id', 'i'+threadId);
    path.setAttribute('fill', 'none');
    path.setAttribute('stroke', 'black');
    defs.appendChild(path);

    return path;
}

function makeTextPath(isReversed, startAt, threadId)
{
    var text = svgElement('text');
    var textPath = svgElement('textPath');
    var animate = svgElement('animate');
    var set = svgElement('set');
    
    textPath.setAttributeNS('http://www.w3.org/1999/xlink', 'href', '#i'+threadId);
    textPath.setAttribute('spacing', 'auto');
    animate.setAttribute('attributeName', 'startOffset');
    animate.setAttribute('begin', startAt+'s');
    animate.setAttribute('dur', (3)+'s'); 
    set.setAttribute('attributeName', 'startOffset');
    set.setAttribute('begin', '0s');
    set.setAttribute('dur', startAt+'s');     

    if (!isReversed)
    {
        textPath.setAttribute('startOffset', '100%');
        textPath.setAttribute('style', 'text-anchor:end');
        animate.setAttribute('from', '200%');
        animate.setAttribute('to', '100%');
        set.setAttribute('to', '200%');
    }
    else {
        animate.setAttribute('from', '-100%');
        animate.setAttribute('to', '0%');
        set.setAttribute('to', '-100%');
    }
    
    //textPath.appendChild(animate);
    //if (startAt > 0) textPath.appendChild(set);
    text.appendChild(textPath);
    svg.appendChild(text);

    return textPath;
}

function makeTooltip(lemma) 
{
    var title = svgElement('title');
    title.innerHTML = data.langs[lemma.l][LANG];
    var transcription = lemma[LANG];
    if (transcription.length > 0)
        title.innerHTML += ' ('+transcription+')';
    
    return title;
}

function makeTspan(lemma)
{
    var span = svgElement('tspan');
    span.setAttribute('fill', lemma.color);
    span.setAttribute('dy', '2');
    span.innerHTML = lemma.w+'&nbsp;&nbsp;&nbsp;';
    span.appendChild(makeTooltip(lemma));
    return span;
}

threadCounter = 0;
function drawThread(thread)
{    
    var isReversed = orderBranch(thread);

    var path = makePath(threadCounter);
    var textPath = makeTextPath(isReversed, 4-thread.length, threadCounter);
    
    var dStr = '';
    for (var i=0;i<thread.length;i++)
    {
        dStr += calcPathCoord(thread, i);
        for (var j=0;j<thread[i].lemmata.length;j++)
        {
            var span = makeTspan(thread[i].lemmata[j]);
            textPath.appendChild(span);
        }        
    }

    path.setAttribute('d', dStr);    
    
    threadCounter++;
    return textPath;
}

function svgElement(name)
{
    return document.createElementNS('http://www.w3.org/2000/svg', name);
}

function initSvg()
{
    svg = svgElement('svg');
    //svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    svg.setAttribute('width', CROWN_SIZE*2);
    svg.setAttribute('height', CROWN_SIZE+TRUNK_HEIGHT);
    defs = svgElement('defs');

    svg.appendChild(defs);
    //defs = svg;
    document.body.appendChild(svg);
}

function drawTree()
{
    initSvg();
    fillTreeWithLemmata(data.tree.langs[0], 0);
    calcTreePos();
    console.log(data.tree);
    
    drawBranches(data.tree, TRUNK_LEMMATA, 0);
}


